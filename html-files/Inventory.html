<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Inventory Management</title>
    <?!= include('Styles'); ?>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-brand">
                <h2>IT Asset Management</h2>
            </div>
            <div class="nav-links">
                <a href="?page=dashboard">Dashboard</a>
                <a href="?page=inventory" class="active">Inventory</a>
                <a href="?page=accountability">Accountability</a>
                <a href="?page=disposal">Disposal</a>
                <a href="?page=reports">Reports</a>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <h1>Asset Inventory Management</h1>
                <button id="addAssetBtn" class="btn btn-primary">
                    <i class="icon">+</i> Add New Asset
                </button>
            </div>

            <!-- Search and Filter Section -->
            <div class="search-filters">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search assets...">
                    <button id="searchBtn" class="btn btn-secondary">Search</button>
                </div>
                <div class="filters">
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                    <select id="statusFilter">
                        <option value="">All Statuses</option>
                    </select>
                    <select id="conditionFilter">
                        <option value="">All Conditions</option>
                    </select>
                </div>
            </div>

            <!-- Assets Table -->
            <div class="table-container">
                <table id="assetsTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Asset Tag</th>
                            <th>Serial Number</th>
                            <th>Category</th>
                            <th>Brand</th>
                            <th>Model</th>
                            <th>Status</th>
                            <th>Condition</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="assetsTableBody">
                        <!-- Assets will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="loading hidden">
                <div class="spinner"></div>
                <p>Loading assets...</p>
            </div>

            <!-- No Data Message -->
            <div id="noDataMessage" class="no-data hidden">
                <p>No assets found. Click "Add New Asset" to get started.</p>
            </div>
        </div>
    </div>

    <!-- Add/Edit Asset Modal -->
    <div id="assetModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Asset</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="assetForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="serialNumber">Serial Number *</label>
                            <input type="text" id="serialNumber" name="serialNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="category">Category *</label>
                            <select id="category" name="category" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="brand">Brand</label>
                            <input type="text" id="brand" name="brand">
                        </div>
                        <div class="form-group">
                            <label for="model">Model</label>
                            <input type="text" id="model" name="model">
                        </div>
                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="condition">Condition *</label>
                            <select id="condition" name="condition" required>
                                <option value="">Select Condition</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="location">Location</label>
                            <select id="location" name="location">
                                <option value="">Select Location</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateReceived">Date Received</label>
                            <input type="date" id="dateReceived" name="dateReceived">
                        </div>
                        <div class="form-group">
                            <label for="purchasePrice">Purchase Price</label>
                            <input type="number" id="purchasePrice" name="purchasePrice" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="supplier">Supplier</label>
                            <input type="text" id="supplier" name="supplier">
                        </div>
                        <div class="form-group">
                            <label for="warrantyExpiry">Warranty Expiry</label>
                            <input type="date" id="warrantyExpiry" name="warrantyExpiry">
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes</label>
                            <textarea id="notes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" id="saveBtn" class="btn btn-primary">Save Asset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this asset? This action cannot be undone.</p>
                <div class="form-actions">
                    <button type="button" id="cancelDeleteBtn" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete Asset</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allAssets = [];
        let currentAsset = null;
        let isEditMode = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeFilters();
            loadAssets();
            setupEventListeners();
        });

        // Initialize filter dropdowns
        function initializeFilters() {
            const categories = <?= JSON.stringify(config.CATEGORIES) ?>;
            const statuses = <?= JSON.stringify(config.STATUSES) ?>;
            const conditions = <?= JSON.stringify(config.CONDITIONS) ?>;
            const locations = <?= JSON.stringify(config.LOCATIONS) ?>;

            populateSelect('categoryFilter', categories);
            populateSelect('category', categories);
            populateSelect('statusFilter', statuses);
            populateSelect('conditionFilter', conditions);
            populateSelect('condition', conditions);
            populateSelect('location', locations);
        }

        // Populate select dropdown
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Add Asset button
            document.getElementById('addAssetBtn').addEventListener('click', openAddModal);

            // Search functionality
            document.getElementById('searchBtn').addEventListener('click', filterAssets);
            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') filterAssets();
            });

            // Filter dropdowns
            document.getElementById('categoryFilter').addEventListener('change', filterAssets);
            document.getElementById('statusFilter').addEventListener('change', filterAssets);
            document.getElementById('conditionFilter').addEventListener('change', filterAssets);

            // Modal controls
            document.querySelectorAll('.close').forEach(btn => {
                btn.addEventListener('click', closeModals);
            });
            document.getElementById('cancelBtn').addEventListener('click', closeModals);
            document.getElementById('cancelDeleteBtn').addEventListener('click', closeModals);

            // Form submission
            document.getElementById('assetForm').addEventListener('submit', saveAsset);
            document.getElementById('confirmDeleteBtn').addEventListener('click', deleteAsset);

            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeModals();
                }
            });
        }

        // Load assets from server
        function loadAssets() {
            showLoading(true);

            google.script.run
                .withSuccessHandler(function(assets) {
                    allAssets = assets || [];
                    displayAssets(allAssets);
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading assets:', error);
                    showError('Failed to load assets: ' + error.message);
                    showLoading(false);
                })
                .getAllAssets();
        }

        // Display assets in table
        function displayAssets(assets) {
            const tbody = document.getElementById('assetsTableBody');

            if (!assets || assets.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('noDataMessage').classList.remove('hidden');
                return;
            }

            document.getElementById('noDataMessage').classList.add('hidden');

            tbody.innerHTML = assets.map(asset => `
                <tr>
                    <td>${asset['Asset Tag'] || ''}</td>
                    <td>${asset['Serial Number'] || ''}</td>
                    <td>${asset['Category'] || ''}</td>
                    <td>${asset['Brand'] || ''}</td>
                    <td>${asset['Model'] || ''}</td>
                    <td><span class="status-badge status-${(asset['Status'] || '').toLowerCase().replace(' ', '-')}">${asset['Status'] || ''}</span></td>
                    <td><span class="condition-badge condition-${(asset['Condition'] || '').toLowerCase().replace(' ', '-')}">${asset['Condition'] || ''}</span></td>
                    <td>${asset['Location'] || ''}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-secondary" onclick="editAsset('${asset['Asset Tag']}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="confirmDeleteAsset('${asset['Asset Tag']}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Filter assets
        function filterAssets() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const conditionFilter = document.getElementById('conditionFilter').value;

            const filteredAssets = allAssets.filter(asset => {
                const matchesSearch = searchTerm === '' ||
                    Object.values(asset).some(value =>
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                const matchesCategory = !categoryFilter || asset['Category'] === categoryFilter;
                const matchesStatus = !statusFilter || asset['Status'] === statusFilter;
                const matchesCondition = !conditionFilter || asset['Condition'] === conditionFilter;

                return matchesSearch && matchesCategory && matchesStatus && matchesCondition;
            });

            displayAssets(filteredAssets);
        }

        // Open add modal
        function openAddModal() {
            isEditMode = false;
            currentAsset = null;
            document.getElementById('modalTitle').textContent = 'Add New Asset';
            document.getElementById('assetForm').reset();
            document.getElementById('assetModal').classList.remove('hidden');
        }

        // Edit asset
        function editAsset(assetTag) {
            const asset = allAssets.find(a => a['Asset Tag'] === assetTag);
            if (!asset) return;

            isEditMode = true;
            currentAsset = asset;
            document.getElementById('modalTitle').textContent = 'Edit Asset';

            // Populate form fields
            document.getElementById('serialNumber').value = asset['Serial Number'] || '';
            document.getElementById('category').value = asset['Category'] || '';
            document.getElementById('brand').value = asset['Brand'] || '';
            document.getElementById('model').value = asset['Model'] || '';
            document.getElementById('description').value = asset['Description'] || '';
            document.getElementById('condition').value = asset['Condition'] || '';
            document.getElementById('location').value = asset['Location'] || '';
            document.getElementById('dateReceived').value = formatDateForInput(asset['Date Received']);
            document.getElementById('purchasePrice').value = asset['Purchase Price'] || '';
            document.getElementById('supplier').value = asset['Supplier'] || '';
            document.getElementById('warrantyExpiry').value = formatDateForInput(asset['Warranty Expiry']);
            document.getElementById('notes').value = asset['Notes'] || '';

            document.getElementById('assetModal').classList.remove('hidden');
        }

        // Save asset
        function saveAsset(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const assetData = {};

            for (let [key, value] of formData.entries()) {
                assetData[key] = value;
            }

            if (isEditMode) {
                assetData['Asset Tag'] = currentAsset['Asset Tag'];

                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            showSuccess('Asset updated successfully');
                            closeModals();
                            loadAssets();
                        } else {
                            showError(response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        showError('Failed to update asset: ' + error.message);
                    })
                    .updateAsset(assetData);
            } else {
                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            showSuccess('Asset added successfully');
                            closeModals();
                            loadAssets();
                        } else {
                            showError(response.message);
                        }
                    })
                    .withFailureHandler(function(error) {
                        showError('Failed to add asset: ' + error.message);
                    })
                    .addAsset(assetData);
            }
        }

        // Confirm delete asset
        function confirmDeleteAsset(assetTag) {
            currentAsset = allAssets.find(a => a['Asset Tag'] === assetTag);
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        // Delete asset
        function deleteAsset() {
            if (!currentAsset) return;

            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        showSuccess('Asset deleted successfully');
                        closeModals();
                        loadAssets();
                    } else {
                        showError(response.message);
                    }
                })
                .withFailureHandler(function(error) {
                    showError('Failed to delete asset: ' + error.message);
                })
                .deleteAsset(currentAsset['Asset Tag']);
        }

        // Close all modals
        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.add('hidden');
            });
        }

        // Utility functions
        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
        }

        function formatDateForInput(dateValue) {
            if (!dateValue) return '';
            const date = new Date(dateValue);
            return date.toISOString().split('T')[0];
        }

        function showSuccess(message) {
            alert('Success: ' + message);
        }

        function showError(message) {
            alert('Error: ' + message);
        }
    </script>

    <style>
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .search-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-box {
            display: flex;
            gap: 0.5rem;
            flex: 1;
        }

        .filters {
            display: flex;
            gap: 0.5rem;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-available { background-color: #28a745; color: white; }
        .status-assigned { background-color: #ffc107; color: black; }
        .status-under-maintenance { background-color: #fd7e14; color: white; }
        .status-disposed { background-color: #dc3545; color: white; }

        .condition-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }

        .condition-brand-new { background-color: #28a745; color: white; }
        .condition-excellent { background-color: #20c997; color: white; }
        .condition-good { background-color: #17a2b8; color: white; }
        .condition-fair { background-color: #ffc107; color: black; }
        .condition-poor { background-color: #fd7e14; color: white; }
    </style>
</body>
</html>